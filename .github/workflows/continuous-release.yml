name: Continuous Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: continuous-release
  cancel-in-progress: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  GCC_SPECS: ""
  FLAKEHUB_DISABLE_TELEMETRY: "1"

jobs:
  # Only proceed if CI passed
  check-ci-success:
    name: Check CI Status
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: CI passed
        run: echo "CI workflow completed successfully, proceeding with release"

  build-linux-windows:
    name: Release ${{ matrix.name }} Bundle
    runs-on: ubuntu-latest
    needs: check-ci-success
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux
            name: Linux
          - target: windows
            name: Windows
    steps:
      - name: Download build artifacts from CI
        uses: actions/download-artifact@v4
        with:
          name: rigel-plugin-${{ matrix.target }}-${{ github.event.workflow_run.head_sha }}
          path: bundled/

      - name: Create archive
        run: |
          cd bundled
          tar -czf ../rigel-plugin-latest-${{ matrix.target }}.tar.gz .
          cd ..

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Development Build"
          prerelease: true
          files: rigel-plugin-latest-${{ matrix.target }}.tar.gz
          body: |
            Automated continuous release from the main branch.

            **Commit:** ${{ github.event.workflow_run.head_sha }}
            **Built:** ${{ github.event.workflow_run.updated_at }}

            These are unsigned development builds. For stable releases, see the [Releases page](https://github.com/${{ github.repository }}/releases).

  build-macos:
    name: Release macOS Bundle
    runs-on: ubuntu-latest
    needs: check-ci-success
    steps:
      - name: Download build artifacts from CI
        uses: actions/download-artifact@v4
        with:
          name: rigel-plugin-macos-${{ github.event.workflow_run.head_sha }}
          path: bundled/

      - name: Create archive
        run: |
          cd bundled
          tar -czf ../rigel-plugin-latest-macos.tar.gz .
          cd ..

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Development Build"
          prerelease: true
          files: rigel-plugin-latest-macos.tar.gz
          body: |
            Automated continuous release from the main branch.

            **Commit:** ${{ github.event.workflow_run.head_sha }}
            **Built:** ${{ github.event.workflow_run.updated_at }}

            These are unsigned development builds. For stable releases, see the [Releases page](https://github.com/${{ github.repository }}/releases).
